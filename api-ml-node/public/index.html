<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Mercado Livre - Tokens</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }

        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }

        .loading {
            color: #007bff;
        }
    </style>
</head>

<body>
    <h1>API Mercado Livre - Gerenciamento de Tokens</h1>

    <div class="container">
        <h2>Obter Access Token com PKCE</h2>
        <p><strong>Passo 1:</strong> Gere uma URL de autoriza√ß√£o segura:</p>
        <button onclick="generateAuthUrl()" id="generateUrlBtn">Gerar URL de Autoriza√ß√£o</button>
        <div id="authUrlResponse" class="response" style="display: none;"></div>

        <p><strong>Passo 2:</strong> Cole o c√≥digo de autoriza√ß√£o aqui:</p>
        <p style="color: #dc3545; font-size: 0.9em;">‚ö†Ô∏è <strong>IMPORTANTE:</strong> O c√≥digo de autoriza√ß√£o expira em
            poucos minutos! Use rapidamente ap√≥s autorizar.</p>
        <input type="text" id="authCode" placeholder="Cole aqui o c√≥digo de autoriza√ß√£o (TG-xxxxxxx)">
        <input type="hidden" id="state" placeholder="State (preenchido automaticamente)">
        <input type="hidden" id="codeVerifier" placeholder="Code Verifier (preenchido automaticamente)">
        <button onclick="getAccessToken()" id="getTokenBtn">Obter Tokens</button>
        <div id="tokenResponse" class="response" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>Renovar Access Token</h2>
        <p>Use o refresh_token para obter um novo access_token:</p>
        <input type="text" id="refreshToken" placeholder="Refresh Token">
        <button onclick="refreshAccessToken()" id="refreshBtn">Renovar Token</button>
        <div id="refreshResponse" class="response" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>Gerenciamento Autom√°tico de Tokens</h2>
        <button onclick="checkTokenStatus()" id="statusBtn">Verificar Status do Token</button>
        <button onclick="getValidToken()" id="validTokenBtn">Obter Token V√°lido</button>
        <button onclick="forceRenewToken()" id="renewBtn">For√ßar Renova√ß√£o</button>
        <div id="tokenManagementResponse" class="response" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>Gerenciamento de Orders</h2>

        <!-- Buscar por ID -->
        <div style="margin-bottom: 15px;">
            <input type="text" id="orderIdInput" placeholder="ID da Order (ex: 2000003508419013)" style="width: 300px;">
            <button onclick="getOrderById()" id="getOrderBtn">Buscar Order</button>
        </div>

        <!-- Filtros por Data -->
        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <h3 style="margin-top: 0;">Filtrar por Data</h3>
            <div style="margin-bottom: 10px;">
                <label>Data Inicial:</label>
                <input type="datetime-local" id="dateFrom" style="margin-left: 10px;">
                <label style="margin-left: 20px;">Data Final:</label>
                <input type="datetime-local" id="dateTo" style="margin-left: 10px;">
            </div>
            <div>
                <button onclick="getOrdersByDate()" id="dateFilterBtn">Filtrar por Data</button>
                <button onclick="getCurrentMonthOrders()" id="currentMonthBtn">M√™s Atual</button>
                <button onclick="setLastWeek()" id="lastWeekBtn">√öltima Semana</button>
                <button onclick="setToday()" id="todayBtn">Hoje</button>
            </div>
        </div>

        <!-- Bot√µes Gerais -->
        <div style="margin-bottom: 15px;">
            <button onclick="getRecentOrders()" id="recentOrdersBtn">Orders Recentes (24h)</button>
            <button onclick="getOrderStats()" id="statsBtn">Estat√≠sticas</button>
            <button onclick="getAllOrders()" id="allOrdersBtn">Todas as Orders</button>
        </div>

        <div id="ordersResponse" class="response" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>Tokens Salvos (.env)</h2>
        <div id="savedTokens">
            <p>Nenhum token salvo ainda.</p>
        </div>
        <button onclick="clearTokens()">Limpar Tokens</button>
    </div>

    <script>
        let currentTokens = null;

        async function generateAuthUrl() {
            const btn = document.getElementById('generateUrlBtn');
            const responseDiv = document.getElementById('authUrlResponse');

            btn.disabled = true;
            btn.textContent = 'Gerando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Gerando URL de autoriza√ß√£o com PKCE...';

            try {
                const response = await fetch('/generateAuthUrl');
                const data = await response.json();

                if (data.success) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `‚úÖ URL gerada com sucesso!<br><br>
                        <strong>Clique no link abaixo para autorizar:</strong><br>
                        <a href="${data.authUrl}" target="_blank" style="color: #007bff; text-decoration: underline;">
                            Autorizar Aplica√ß√£o no Mercado Livre
                        </a><br><br>
                        <small>State: ${data.state || 'N/A'}<br>
                        Code Verifier: ${data.code_verifier ? data.code_verifier.substring(0, 20) + '...' : 'N/A'}</small>`;

                    // Armazena os dados para usar depois
                    if (data.state) {
                        document.getElementById('state').value = data.state;
                    }
                    if (data.code_verifier) {
                        document.getElementById('codeVerifier').value = data.code_verifier;
                    }
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå Erro ao gerar URL!\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Gerar URL de Autoriza√ß√£o';
            }
        }

        async function getAccessToken() {
            const btn = document.getElementById('getTokenBtn');
            const responseDiv = document.getElementById('tokenResponse');
            const authCode = document.getElementById('authCode').value;
            const state = document.getElementById('state').value;
            const codeVerifier = document.getElementById('codeVerifier').value;

            if (!authCode) {
                alert('Por favor, insira o c√≥digo de autoriza√ß√£o!');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Aguardando resposta...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Fazendo requisi√ß√£o para obter tokens com PKCE...\nAguarde a resposta do servidor...';

            try {
                const requestBody = {
                    code: authCode,
                    state: state,
                    code_verifier: codeVerifier
                };

                const response = await fetch('/getAccessToken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Verifica se a resposta tem access_token (sucesso) ou error (erro)
                if (data.access_token) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = `‚úÖ Tokens obtidos com sucesso!\n\n${JSON.stringify(data, null, 2)}`;

                    // Salva os tokens
                    currentTokens = data;
                    localStorage.setItem('mlTokens', JSON.stringify(currentTokens));
                    updateSavedTokensDisplay();

                    // Preenche automaticamente o refresh token
                    if (data.refresh_token) {
                        document.getElementById('refreshToken').value = data.refresh_token;
                    }
                } else {
                    responseDiv.className = 'response error';
                    let errorText = `‚ùå ${data.message || 'Erro!'}\n\n`;

                    if (data.help) {
                        errorText += `üí° Ajuda: ${data.help}\n\n`;
                    }

                    errorText += `Detalhes t√©cnicos:\n${JSON.stringify(data, null, 2)}`;
                    responseDiv.textContent = errorText;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Obter Tokens';
            }
        }



        async function refreshAccessToken() {
            const btn = document.getElementById('refreshBtn');
            const responseDiv = document.getElementById('refreshResponse');
            const refreshToken = document.getElementById('refreshToken').value;

            if (!refreshToken) {
                alert('Por favor, insira o refresh token');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Renovando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Renovando access token...\nAguarde a resposta do servidor...';

            try {
                const response = await fetch('/refreshToken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                const data = await response.json();

                // Verifica se a resposta tem access_token (sucesso) ou error (erro)
                if (data.access_token) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = `‚úÖ Token renovado com sucesso!\n\n${JSON.stringify(data, null, 2)}`;

                    // Atualiza os tokens salvos
                    currentTokens = data;
                    localStorage.setItem('mlTokens', JSON.stringify(currentTokens));
                    updateSavedTokensDisplay();
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå Erro ao renovar!\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Renovar Token';
            }
        }

        function updateSavedTokensDisplay() {
            const savedTokensDiv = document.getElementById('savedTokens');
            const tokens = localStorage.getItem('mlTokens');

            if (tokens) {
                const tokenData = JSON.parse(tokens);
                savedTokensDiv.innerHTML = `
                    <div class="response success">
                        <strong>Tokens Atuais:</strong><br>
                        Access Token: ${tokenData.access_token ? tokenData.access_token.substring(0, 20) + '...' : 'N/A'}<br>
                        Refresh Token: ${tokenData.refresh_token ? tokenData.refresh_token.substring(0, 20) + '...' : 'N/A'}<br>
                        Expira em: ${tokenData.expires_in} segundos<br>
                        Salvo em: ${tokenData.timestamp}
                    </div>
                `;
            } else {
                savedTokensDiv.innerHTML = '<p>Nenhum token salvo ainda.</p>';
            }
        }

        async function checkTokenStatus() {
            const btn = document.getElementById('statusBtn');
            const responseDiv = document.getElementById('tokenManagementResponse');

            btn.disabled = true;
            btn.textContent = 'Verificando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Verificando status do token...';

            try {
                const response = await fetch('/tokenStatus');
                const data = await response.json();

                responseDiv.className = data.status === 'valid' ? 'response success' : 'response error';
                responseDiv.textContent = `Status: ${data.status.toUpperCase()}\n\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verificar Status do Token';
            }
        }

        async function getValidToken() {
            const btn = document.getElementById('validTokenBtn');
            const responseDiv = document.getElementById('tokenManagementResponse');

            btn.disabled = true;
            btn.textContent = 'Obtendo...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Obtendo token v√°lido (renovando se necess√°rio)...';

            try {
                const response = await fetch('/getValidToken');
                const data = await response.json();

                if (data.access_token) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = `‚úÖ Token v√°lido obtido!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error}\n\n√â necess√°rio fazer nova autoriza√ß√£o.`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Obter Token V√°lido';
            }
        }

        async function forceRenewToken() {
            const btn = document.getElementById('renewBtn');
            const responseDiv = document.getElementById('tokenManagementResponse');

            btn.disabled = true;
            btn.textContent = 'Renovando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'For√ßando renova√ß√£o do token...';

            try {
                const response = await fetch('/forceRenewToken', { method: 'POST' });
                const data = await response.json();

                if (data.access_token) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = `‚úÖ Token renovado com sucesso!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error}\n\n√â necess√°rio fazer nova autoriza√ß√£o.`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'For√ßar Renova√ß√£o';
            }
        }

        async function getOrderById() {
            const btn = document.getElementById('getOrderBtn');
            const responseDiv = document.getElementById('ordersResponse');
            const orderId = document.getElementById('orderIdInput').value;

            if (!orderId) {
                alert('Por favor, insira o ID da order!');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Buscando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = `Buscando order ${orderId}...`;

            try {
                const response = await fetch(`/orders/${orderId}`);
                const data = await response.json();

                if (response.ok && data.id) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `
                        <strong>üì¶ Order ${data.id}</strong><br>
                        <strong>Status:</strong> ${data.status}<br>
                        <strong>Total:</strong> R$ ${data.total_amount}<br>
                        <strong>Data:</strong> ${new Date(data.date_created).toLocaleString('pt-BR')}<br>
                        <strong>Comprador:</strong> ${data.buyer.id}<br>
                        <strong>Items:</strong> ${data.order_items.length}<br><br>
                        <details>
                            <summary>Ver JSON completo</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error || 'Order n√£o encontrada'}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Buscar Order';
            }
        }

        async function getRecentOrders() {
            const btn = document.getElementById('recentOrdersBtn');
            const responseDiv = document.getElementById('ordersResponse');

            btn.disabled = true;
            btn.textContent = 'Carregando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Buscando orders das √∫ltimas 24 horas...';

            try {
                const response = await fetch('/orders/recent');
                const data = await response.json();

                if (response.ok && data.results) {
                    responseDiv.className = 'response success';
                    let html = `<strong>üïê Orders Recentes (${data.total})</strong><br><br>`;

                    if (data.results.length === 0) {
                        html += 'Nenhuma order encontrada nas √∫ltimas 24 horas.';
                    } else {
                        data.results.forEach(order => {
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                    <strong>Order:</strong> ${order.id}<br>
                                    <strong>Status:</strong> ${order.status}<br>
                                    <strong>Valor:</strong> R$ ${order.total_amount}<br>
                                    <strong>Data:</strong> ${new Date(order.date_created).toLocaleString('pt-BR')}
                                </div>
                            `;
                        });
                    }

                    html += `<br><details><summary>Ver JSON completo</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
                    responseDiv.innerHTML = html;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error || 'Erro ao buscar orders'}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Orders Recentes (24h)';
            }
        }

        async function getOrderStats() {
            const btn = document.getElementById('statsBtn');
            const responseDiv = document.getElementById('ordersResponse');

            btn.disabled = true;
            btn.textContent = 'Calculando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Calculando estat√≠sticas de orders...';

            try {
                const response = await fetch('/orders/stats');
                const data = await response.json();

                if (response.ok && data.total_orders !== undefined) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `
                        <strong>üìä Estat√≠sticas de Orders</strong><br><br>
                        <strong>Total de Orders:</strong> ${data.total_orders}<br>
                        <strong>Valor Total:</strong> R$ ${data.total_amount.toFixed(2)}<br>
                        <strong>Valor Pago:</strong> R$ ${data.paid_amount.toFixed(2)}<br>
                        <strong>Ticket M√©dio:</strong> R$ ${data.average_order_value.toFixed(2)}<br>
                        <strong>Orders Recentes (24h):</strong> ${data.recent_orders}<br><br>
                        
                        <strong>Por Status:</strong><br>
                        ${Object.entries(data.status_breakdown).map(([status, count]) =>
                        `‚Ä¢ ${status}: ${count}`
                    ).join('<br>')}<br><br>
                        
                        <strong>M√©todos de Pagamento:</strong><br>
                        ${Object.entries(data.payment_methods).map(([method, count]) =>
                        `‚Ä¢ ${method}: ${count}`
                    ).join('<br>')}<br><br>
                        
                        <details>
                            <summary>Ver JSON completo</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error || 'Erro ao calcular estat√≠sticas'}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Estat√≠sticas';
            }
        }

        async function getAllOrders() {
            const btn = document.getElementById('allOrdersBtn');
            const responseDiv = document.getElementById('ordersResponse');

            btn.disabled = true;
            btn.textContent = 'Carregando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Buscando todas as orders...';

            try {
                const response = await fetch('/orders?limit=50');
                const data = await response.json();

                if (response.ok && data.results) {
                    responseDiv.className = 'response success';
                    let html = `<strong>üìã Todas as Orders (${data.paging.total})</strong><br><br>`;

                    if (data.results.length === 0) {
                        html += 'Nenhuma order encontrada.';
                    } else {
                        data.results.forEach(order => {
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                    <strong>Order:</strong> ${order.id}<br>
                                    <strong>Status:</strong> ${order.status}<br>
                                    <strong>Valor:</strong> R$ ${order.total_amount}<br>
                                    <strong>Data:</strong> ${new Date(order.date_created).toLocaleString('pt-BR')}
                                </div>
                            `;
                        });
                    }

                    html += `<br><details><summary>Ver JSON completo</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
                    responseDiv.innerHTML = html;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error || 'Erro ao buscar orders'}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Todas as Orders';
            }
        }

        async function getOrdersByDate() {
            const btn = document.getElementById('dateFilterBtn');
            const responseDiv = document.getElementById('ordersResponse');
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (!dateFrom || !dateTo) {
                alert('Por favor, selecione as datas inicial e final!');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Filtrando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Filtrando orders por data...';

            try {
                // Converter para formato ISO com timezone
                const dateFromISO = new Date(dateFrom).toISOString();
                const dateToISO = new Date(dateTo).toISOString();

                const response = await fetch(`/orders/by-date?date_from=${dateFromISO}&date_to=${dateToISO}`);
                const data = await response.json();

                if (response.ok && data.results) {
                    responseDiv.className = 'response success';
                    let html = `<strong>üìÖ Orders por Data (${data.total})</strong><br>`;
                    html += `<strong>Per√≠odo:</strong> ${new Date(dateFrom).toLocaleString('pt-BR')} at√© ${new Date(dateTo).toLocaleString('pt-BR')}<br><br>`;

                    if (data.results.length === 0) {
                        html += 'Nenhuma order encontrada no per√≠odo selecionado.';
                    } else {
                        let totalValue = 0;
                        data.results.forEach(order => {
                            totalValue += order.total_amount || 0;
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                    <strong>Order:</strong> ${order.id}<br>
                                    <strong>Status:</strong> ${order.status}<br>
                                    <strong>Valor:</strong> R$ ${order.total_amount}<br>
                                    <strong>Data:</strong> ${new Date(order.date_created).toLocaleString('pt-BR')}
                                </div>
                            `;
                        });
                        html += `<br><strong>üí∞ Valor Total do Per√≠odo:</strong> R$ ${totalValue.toFixed(2)}`;
                    }

                    html += `<br><br><details><summary>Ver JSON completo</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
                    responseDiv.innerHTML = html;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error || 'Erro ao filtrar por data'}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Filtrar por Data';
            }
        }

        async function getCurrentMonthOrders() {
            const btn = document.getElementById('currentMonthBtn');
            const responseDiv = document.getElementById('ordersResponse');

            btn.disabled = true;
            btn.textContent = 'Carregando...';
            responseDiv.style.display = 'block';
            responseDiv.className = 'response loading';
            responseDiv.textContent = 'Buscando orders do m√™s atual...';

            try {
                const response = await fetch('/orders/current-month');
                const data = await response.json();

                if (response.ok && data.results) {
                    responseDiv.className = 'response success';
                    let html = `<strong>üìÖ Orders do M√™s Atual (${data.total})</strong><br>`;
                    html += `<strong>Per√≠odo:</strong> ${data.period_info.month}/${data.period_info.year}<br><br>`;

                    if (data.results.length === 0) {
                        html += 'Nenhuma order encontrada no m√™s atual.';
                    } else {
                        let totalValue = 0;
                        data.results.forEach(order => {
                            totalValue += order.total_amount || 0;
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                    <strong>Order:</strong> ${order.id}<br>
                                    <strong>Status:</strong> ${order.status}<br>
                                    <strong>Valor:</strong> R$ ${order.total_amount}<br>
                                    <strong>Data:</strong> ${new Date(order.date_created).toLocaleString('pt-BR')}
                                </div>
                            `;
                        });
                        html += `<br><strong>üí∞ Valor Total do M√™s:</strong> R$ ${totalValue.toFixed(2)}`;
                    }

                    html += `<br><br><details><summary>Ver JSON completo</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
                    responseDiv.innerHTML = html;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `‚ùå ${data.error || 'Erro ao buscar m√™s atual'}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.textContent = `‚ùå Erro de conex√£o!\n\n${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'M√™s Atual';
            }
        }

        function setLastWeek() {
            const now = new Date();
            const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            document.getElementById('dateFrom').value = lastWeek.toISOString().slice(0, 16);
            document.getElementById('dateTo').value = now.toISOString().slice(0, 16);
        }

        function setToday() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59);

            document.getElementById('dateFrom').value = startOfDay.toISOString().slice(0, 16);
            document.getElementById('dateTo').value = endOfDay.toISOString().slice(0, 16);
        }

        function clearTokens() {
            localStorage.removeItem('mlTokens');
            currentTokens = null;
            updateSavedTokensDisplay();
            document.getElementById('refreshToken').value = '';
        }

        // Carrega tokens salvos ao inicializar
        window.onload = function () {
            updateSavedTokensDisplay();
            const savedTokens = localStorage.getItem('mlTokens');
            if (savedTokens) {
                const tokenData = JSON.parse(savedTokens);
                if (tokenData.refresh_token) {
                    document.getElementById('refreshToken').value = tokenData.refresh_token;
                }
            }
        };
    </script>
</body>

</html>